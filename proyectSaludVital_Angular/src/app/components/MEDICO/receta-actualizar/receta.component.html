<div *ngIf="mensajeExito" class="alert-success">{{ mensajeExito }}</div>
<div *ngIf="mensajeError" class="alert-error">{{ mensajeError }}</div>

<div *ngIf="editar" class="panel-edicion">
  <h3>Editar Receta (BORRADOR)</h3>
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <input type="hidden" formControlName="idReceta">

    <label>Médico:</label>
    <input type="text" formControlName="medicoNombre" readonly>

    <label>Paciente:</label>
    <input type="text" formControlName="pacienteNombre" readonly>

    <label>Fecha Emisión:</label>
    <input type="date" formControlName="fechaEmision" readonly>

    <label>Fecha Vencimiento:</label>
    <input type="date" formControlName="fechaCaducidad" readonly>

    <div formArrayName="items">
      <div *ngFor="let item of items.controls; let i = index" [formGroupName]="i" class="item-edicion">
        <label>Medicamento ID:</label>
        <input type="number" formControlName="medicamentoId">

        <label>Dosis:</label>
        <input type="text" formControlName="dosis">

        <label>Frecuencia:</label>
        <input type="text" formControlName="frecuencia">

        <button type="button" class="btn-danger" (click)="eliminarItem(i)">Eliminar</button>
      </div>
    </div>

    <button type="button" class="btn-success" (click)="agregarItem()">+ Agregar Medicamento</button>
    <button type="submit" class="btn-primary">Guardar cambios</button>
  </form>
</div>

<h2>Lista de Recetas</h2>
<div *ngIf="cargando">Cargando recetas...</div>
<div *ngIf="!cargando && recetas.length === 0" class="empty-state">
  No hay recetas para actualizar por el momento.
</div>

<table *ngIf="!cargando && recetas.length > 0">
  <thead>
    <tr>
      <th>ID</th>
      <th>Médico</th>
      <th>Paciente</th>
      <th>Fecha Emisión</th>
      <th>Fecha Vencimiento</th>
      <th>Estado</th>
      <th>Medicamentos</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let receta of recetas">
      <td>{{ receta.id }}</td>
      <td>{{ receta.medicoNombre }}</td>
      <td>{{ receta.pacienteNombre }}</td>
      <td>{{ receta.fechaEmision | date:'shortDate' }}</td>
      <td>{{ receta.fechaCaducidad | date:'shortDate' }}</td>
      <td><span class="badge" [ngClass]="obtenerClaseEstado(receta.estado)">{{ receta.estado }}</span></td>
      <td>
        <button type="button" class="btn-success" (click)="receta.showItems = !receta.showItems">
          {{ receta.showItems ? 'Ocultar' : 'Ver Medicamentos' }}
        </button>
        <ul *ngIf="receta.showItems">
          <li *ngFor="let h of receta.items">
            {{ h.medicamentoNombre }}: {{ h.dosis }} - {{ h.frecuencia }}
          </li>
        </ul>
      </td>
      <td>
        <button *ngIf="receta.estado === 'BORRADOR'" type="button" class="btn-warning" (click)="editarReceta(receta)">Editar</button>

        <ng-container *ngIf="receta.estado === 'EMITIDA'">
          <button type="button" class="btn-danger" (click)="anularReceta(receta)">Anular</button>
          <button type="button" class="btn-primary" (click)="duplicarReceta(receta)">Duplicar</button>
        </ng-container>

        <button *ngIf="receta.estado === 'VENCIDA'" type="button" class="btn-primary" (click)="renovarReceta(receta)">Renovar</button>

        <button
          *ngIf="receta.estado === 'ANULADA' || receta.estado === 'DISPENSADA'"
          type="button"
          class="btn-secondary"
          (click)="verReceta(receta)">
          Ver detalle
        </button>
      </td>
    </tr>
  </tbody>
</table>

<div *ngIf="recetaDetalle" class="detalle-overlay" (click)="cerrarDetalle()">
  <div class="detalle-modal" (click)="$event.stopPropagation()">
    <h3>Detalle de receta #{{ recetaDetalle.id }}</h3>
    <p><strong>Médico:</strong> {{ recetaDetalle.medicoNombre }}</p>
    <p><strong>Paciente:</strong> {{ recetaDetalle.pacienteNombre }}</p>
    <p><strong>Estado:</strong> <span class="badge" [ngClass]="obtenerClaseEstado(recetaDetalle.estado)">{{ recetaDetalle.estado }}</span></p>
    <p><strong>Fecha Emisión:</strong> {{ recetaDetalle.fechaEmision | date:'shortDate' }}</p>
    <p><strong>Fecha Vencimiento:</strong> {{ recetaDetalle.fechaCaducidad | date:'shortDate' }}</p>

    <h4>Medicamentos</h4>
    <ul>
      <li *ngFor="let item of recetaDetalle.items">
        {{ item.medicamentoNombre }}: {{ item.dosis }} - {{ item.frecuencia }}
      </li>
    </ul>

    <button type="button" class="btn-primary" (click)="cerrarDetalle()">Cerrar</button>
  </div>
</div>
