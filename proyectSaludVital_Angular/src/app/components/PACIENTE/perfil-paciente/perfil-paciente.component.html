<div *ngIf="paciente; else errorTemplate" class="container">

  <h2>Perfil de {{ paciente.nombre }}</h2>

  <!-- Vista normal -->
  <div *ngIf="!editar" class="card perfil-card">
    <div class="card-section">
      <h3>Datos personales</h3>
      <p><strong>Nombre:</strong> {{ paciente.nombre }}</p>
      <p><strong>NÃºmero de identificaciÃ³n:</strong> {{ paciente.numeroIdentificacion }}</p>
      <p><strong>Fecha de nacimiento:</strong> {{ paciente.fechaNacimiento }}</p>
      <p><strong>Usuario ID:</strong> {{ paciente.usuarioId }}</p>
      <img class="thumb" [src]="paciente.imagenUrl || '/images/no-image-person.svg'" alt="Foto paciente">
    </div>

    <div class="card-section">
      <h3>Alergias</h3>
      <div *ngIf="paciente.alergias && paciente.alergias.length > 0; else noAlergias">
        <div class="chip" *ngFor="let alergia of paciente.alergias">
          {{ alergia }}
        </div>
      </div>
      <ng-template #noAlergias><p>No registradas</p></ng-template>
    </div>

    <div class="card-section">
      <h3>Enfermedades</h3>
      <div *ngIf="paciente.enfermedades && paciente.enfermedades.length > 0; else noEnfermedades">
        <div class="chip disease" *ngFor="let enfermedad of paciente.enfermedades">
          {{ enfermedad }}
        </div>
      </div>
      <ng-template #noEnfermedades><p>No registradas</p></ng-template>
    </div>

    <div class="actions">
      <button class="btn btn-primary" (click)="editarPaciente(paciente)">Actualizar</button>
    </div>
  </div>

  <!-- Formulario de ediciÃ³n -->
  <div *ngIf="editar" class="card">
    <form [formGroup]="form" (ngSubmit)="guardar()">

      <p *ngIf="mensaje" [class]="mensajeError ? 'text-danger' : 'text-success'">{{ mensaje }}</p>

      <h3>Editar datos</h3>
      <label>Nombre</label>
      <input formControlName="nombre" class="form-control">
        <small class="text-danger" *ngIf="form.get('nombre')?.invalid && form.get('nombre')?.touched">
          El nombre es obligatorio.
        </small>

      <label>NÃºmero de identificaciÃ³n</label>
      <input formControlName="numeroIdentificacion" class="form-control">
        <small class="text-danger" *ngIf="form.get('numeroIdentificacion')?.invalid && form.get('numeroIdentificacion')?.touched">
          Debe contener exactamente 8 dÃ­gitos.
        </small>

      <label>Fecha de nacimiento</label>
      <input type="date" formControlName="fechaNacimiento" class="form-control">
        <small class="text-danger" *ngIf="form.get('fechaNacimiento')?.invalid && form.get('fechaNacimiento')?.touched">
          La fecha de nacimiento es obligatoria.
        </small>

      <h3>Alergias</h3>
      <div formArrayName="alergias" class="list-form">
        <div *ngFor="let a of alergias.controls; let i = index" [formGroupName]="i" class="list-item">
          <input formControlName="nombre" class="form-control">
          <button type="button" (click)="eliminarAlergia(i)">âŒ</button>
        </div>
      </div>
      <button type="button" class="btn btn-primary" (click)="agregarAlergia()">â• Agregar Alergia</button>

      <h3>Enfermedades</h3>
      <div formArrayName="enfermedades" class="list-form">
        <div *ngFor="let e of enfermedades.controls; let i = index" [formGroupName]="i" class="list-item">
          <input formControlName="nombre" class="form-control">
          <button type="button" (click)="eliminarEnfermedad(i)">âŒ</button>
        </div>
      </div>
      <button type="button" class="btn btn-primary" (click)="agregarEnfermedad()">â• Agregar Enfermedad</button>

      <div class="actions">
        <button type="submit" class="btn btn-success">ğŸ’¾ Guardar</button>
        <button type="button" class="btn btn-secondary" (click)="cancelarEdicion()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Error -->
<ng-template #errorTemplate>
  <p class="text-danger">{{ error }}</p>
</ng-template>
