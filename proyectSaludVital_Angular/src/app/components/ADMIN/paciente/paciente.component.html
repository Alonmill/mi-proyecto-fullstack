<h2 class="section-title">{{ editar ? 'Actualizar Paciente' : 'Agregar Paciente' }}</h2>

<div *ngIf="mensajeExito" class="alert-success">{{ mensajeExito }}</div>
<div *ngIf="mensajeError" class="alert-error">{{ mensajeError }}</div>
<form [formGroup]="form" (ngSubmit)="guardar()">

  <div>
  <label for="nombre">Nombre:</label>
  <input id="nombre" formControlName="nombre" placeholder="Nombre" />
  <div class="error" *ngIf="form.get('nombre')?.touched && form.get('nombre')?.hasError('required')">
    El nombre es obligatorio.
  </div>
</div>

<div>
  <label for="numeroIdentificacion">Número de Identificación:</label>
  <input id="numeroIdentificacion" formControlName="numeroIdentificacion" placeholder="Número Identificación" />
  <div class="error" *ngIf="form.get('numeroIdentificacion')?.touched">
    <span *ngIf="form.get('numeroIdentificacion')?.hasError('required')">
      El número de identificación es obligatorio.
    </span>
    <span *ngIf="form.get('numeroIdentificacion')?.hasError('pattern')">
      Debe contener exactamente 8 dígitos numéricos.
    </span>
  </div>
</div>

<div>
  <label for="fechaNacimiento">Fecha de Nacimiento:</label>
  <input id="fechaNacimiento" type="date" formControlName="fechaNacimiento" placeholder="Fecha de Nacimiento" />
  <div class="error" *ngIf="form.get('fechaNacimiento')?.touched && form.get('fechaNacimiento')?.hasError('required')">
    La fecha de nacimiento es obligatoria.
  </div>
</div>

<div>
  <label for="emailUsuario">Buscar usuario por email:</label>
  <div class="usuario-search-row">
    <input id="emailUsuario" [(ngModel)]="emailBusquedaUsuario" [ngModelOptions]="{standalone: true}" (ngModelChange)="onEmailInputChange()" placeholder="correo@dominio.com" autocomplete="off" />
  </div>
  <ul *ngIf="sugerenciasUsuarios.length > 0" class="autocomplete-list">
    <li *ngFor="let usuario of sugerenciasUsuarios" (click)="seleccionarUsuario(usuario)">
      {{ usuario.email }} <span>#{{ usuario.id }}</span>
    </li>
  </ul>
</div>

<div>
  <label for="usuarioId">Usuario Id:</label>
  <input id="usuarioId" formControlName="usuarioId" placeholder="Usuario ID" />
  <div class="error" *ngIf="form.get('usuarioId')?.touched">
    <span *ngIf="form.get('usuarioId')?.hasError('required')">
      El usuario ID es obligatorio.
    </span>
    <span *ngIf="form.get('usuarioId')?.hasError('pattern')">
      Solo se permiten números.
    </span>
  </div>
</div>

  

  
<div class="file-upload-field">
  <label for="imagenUrl">Foto del paciente:</label>
  <input id="imagenUrl" class="file-input" type="file" accept="image/png,image/jpeg" (change)="onImageSelected($event)" />
  <small class="file-help">Formatos permitidos: JPG, JPEG o PNG (máx. 2MB).</small>
  <small class="file-name" *ngIf="selectedImageFile">Seleccionada: {{ selectedImageFile.name }}</small>
</div>

<div class="grupo-seccion" formArrayName="alergias">
  <h3>Alergias</h3>
  <div class="item-seccion" *ngFor="let a of alergias.controls; let i=index" [formGroupName]="i">
    <label>Nombre Alergia:</label>
    <input formControlName="nombre" placeholder="Nombre de alergia" />
    <button class="btn-danger" type="button" (click)="eliminarAlergia(i)">Eliminar</button>
  </div>
</div>
<button class="btn-add" type="button" (click)="agregarAlergia()">Agregar Alergia</button>

<div class="grupo-seccion" formArrayName="enfermedades">
  <h3>Enfermedades</h3>
  <div class="item-seccion" *ngFor="let e of enfermedades.controls; let i=index" [formGroupName]="i">
    <label>Nombre Enfermedad:</label>
    <input formControlName="nombre" placeholder="Nombre de Enfermedad" />
    <button class="btn-danger" type="button" (click)="eliminarEnfermedad(i)">Eliminar</button>
  </div>
</div>
<button class="btn-add" type="button" (click)="agregarEnfermedad()">Agregar Enfermedad</button>

  <div class="acciones-form">
    <button class="btn-primary" type="submit">{{ editar ? 'Actualizar' : 'Guardar' }}</button>
    <button *ngIf="editar" type="button" (click)="cancelarEdicion()">Cancelar</button>
  </div>
</form>

<h2 class="section-title">Lista de Pacientes</h2>

<table border="1" cellpadding="5" cellspacing="0">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Numero Identificacion</th>
      <th>Fecha de Nacimiento</th>
      <th>Usuario ID</th>
      <th>Foto</th>
      <th>Alergias</th>
      <th>Enfermedades</th>
      <th>Acciones</th>
      
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let p of pacientesPaginados">
      <td>{{ p.nombre }}</td>
      <td>{{ p.numeroIdentificacion }}</td>
      <td>{{ p.fechaNacimiento}}</td>
      <td>{{ p.usuarioId }}</td>
      <td><img class="thumb" [src]="resolveImageUrl(p.imagenUrl)" alt="Foto paciente"></td>
      <td>
        <button type="button" (click)="p.showAlergias = !p.showAlergias">
          {{ p.showAlergias ? 'Ocultar' : 'Ver Alergias' }}
        </button>
        <ul *ngIf="p.showAlergias">
          <li *ngFor="let a of p.alergias">
            {{ a }}
          </li>
        </ul>
      </td>

      <td>
        <button type="button" (click)="p.showEnfermedades = !p.showEnfermedades">
          {{ p.showEnfermedades ? 'Ocultar' : 'Ver Enfermedades' }}
        </button>
        <ul *ngIf="p.showEnfermedades">
          <li *ngFor="let e of p.enfermedades">
            {{ e }}
          </li>
        </ul>
      </td>

      <td>
        <button type="button" (click)="editarPaciente(p)">Actualizar</button>
      </td>
    </tr>
  </tbody>
</table>

<div *ngIf="mensajeError" class="alert-error">
  {{ mensajeError }}
</div>

<div class="pagination" *ngIf="pacientes.length > 0">
  <button type="button" (click)="paginaAnterior()" [disabled]="paginaActual === 1">Anterior</button>
  <button
    type="button"
    *ngFor="let pagina of paginas"
    (click)="irPagina(pagina)"
    [class.active]="pagina === paginaActual">
    {{ pagina }}
  </button>
  <button type="button" (click)="paginaSiguiente()" [disabled]="paginaActual === totalPaginas">Siguiente</button>
</div>
